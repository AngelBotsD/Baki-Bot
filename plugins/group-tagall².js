const handler = async (m, { conn, participants, isAdmin, isOwner }) => {
  if (!m.isGroup) return;
  if (!isAdmin && !isOwner) return global.dfail?.('admin', m, conn);

  const total = participants.length;

  // === MAPA DE C√ìDIGOS TELEF√ìNICOS -> BANDERAS ===
  const flags = {
    '1': 'üá∫üá∏', '7': 'üá∑üá∫', '20': 'üá™üá¨', '27': 'üáøüá¶', '30': 'üá¨üá∑', '31': 'üá≥üá±', '32': 'üáßüá™',
    '33': 'üá´üá∑', '34': 'üá™üá∏', '36': 'üá≠üá∫', '39': 'üáÆüáπ', '40': 'üá∑üá¥', '41': 'üá®üá≠', '43': 'üá¶üáπ',
    '44': 'üá¨üáß', '45': 'üá©üá∞', '46': 'üá∏üá™', '47': 'üá≥üá¥', '48': 'üáµüá±', '49': 'üá©üá™',
    '51': 'üáµüá™', '52': 'üá≤üáΩ', '53': 'üá®üá∫', '54': 'üá¶üá∑', '55': 'üáßüá∑', '56': 'üá®üá±',
    '57': 'üá®üá¥', '58': 'üáªüá™', '60': 'üá≤üáæ', '61': 'üá¶üá∫', '62': 'üáÆüá©', '63': 'üáµüá≠',
    '64': 'üá≥üáø', '65': 'üá∏üá¨', '66': 'üáπüá≠', '81': 'üáØüáµ', '82': 'üá∞üá∑', '84': 'üáªüá≥',
    '86': 'üá®üá≥', '90': 'üáπüá∑', '91': 'üáÆüá≥', '92': 'üáµüá∞', '93': 'üá¶üá´', '94': 'üá±üá∞',
    '95': 'üá≤üá≤', '98': 'üáÆüá∑', '211': 'üá∏üá∏', '212': 'üá≤üá¶', '213': 'üá©üáø', '216': 'üáπüá≥',
    '218': 'üá±üáæ', '220': 'üá¨üá≤', '221': 'üá∏üá≥', '222': 'üá≤üá∑', '223': 'üá≤üá±', '224': 'üá¨üá≥',
    '225': 'üá®üáÆ', '226': 'üáßüá´', '227': 'üá≥üá™', '228': 'üáπüá¨', '229': 'üáßüáØ', '230': 'üá≤üá∫',
    '231': 'üá±üá∑', '232': 'üá∏üá±', '233': 'üá¨üá≠', '234': 'üá≥üá¨', '235': 'üáπüá©', '236': 'üá®üá´',
    '237': 'üá®üá≤', '238': 'üá®üáª', '239': 'üá∏üáπ', '240': 'üá¨üá∂', '241': 'üá¨üá¶', '242': 'üá®üá¨',
    '243': 'üá®üá©', '244': 'üá¶üá¥', '248': 'üá∏üá®', '249': 'üá∏üá©', '250': 'üá∑üáº', '251': 'üá™üáπ',
    '252': 'üá∏üá¥', '253': 'üá©üáØ', '254': 'üá∞üá™', '255': 'üáπüáø', '256': 'üá∫üá¨', '260': 'üáøüá≤',
    '261': 'üá≤üá¨', '263': 'üáøüáº', '264': 'üá≥üá¶', '265': 'üá≤üáº', '266': 'üá±üá∏', '267': 'üáßüáº',
    '268': 'üá∏üáø', '269': 'üá∞üá≤', '291': 'üá™üá∑', '297': 'üá¶üáº', '298': 'üá´üá¥', '299': 'üá¨üá±',
    '350': 'üá¨üáÆ', '351': 'üáµüáπ', '352': 'üá±üá∫', '353': 'üáÆüá™', '354': 'üáÆüá∏', '355': 'üá¶üá±',
    '356': 'üá≤üáπ', '357': 'üá®üáæ', '358': 'üá´üáÆ', '359': 'üáßüá¨', '370': 'üá±üáπ', '371': 'üá±üáª',
    '372': 'üá™üá™', '373': 'üá≤üá©', '374': 'üá¶üá≤', '375': 'üáßüáæ', '376': 'üá¶üá©', '377': 'üá≤üá®',
    '378': 'üá∏üá≤', '380': 'üá∫üá¶', '381': 'üá∑üá∏', '382': 'üá≤üá™', '383': 'üáΩüá∞', '385': 'üá≠üá∑',
    '386': 'üá∏üáÆ', '387': 'üáßüá¶', '389': 'üá≤üá∞', '420': 'üá®üáø', '421': 'üá∏üá∞', '423': 'üá±üáÆ',
    '500': 'üá´üá∞', '501': 'üáßüáø', '502': 'üá¨üáπ', '503': 'üá∏üáª', '504': 'üá≠üá≥', '505': 'üá≥üáÆ',
    '506': 'üá®üá∑', '507': 'üáµüá¶', '509': 'üá≠üáπ', '591': 'üáßüá¥', '592': 'üá¨üáæ', '593': 'üá™üá®',
    '594': 'üá¨üá´', '595': 'üáµüáæ', '597': 'üá∏üá∑', '598': 'üá∫üáæ', '670': 'üáπüá±', '672': 'üá¶üá∂',
    '673': 'üáßüá≥', '674': 'üá≥üá∑', '675': 'üáµüá¨', '676': 'üáπüá¥', '677': 'üá∏üáß', '678': 'üáªüá∫',
    '679': 'üá´üáØ', '680': 'üáµüáº', '681': 'üáºüá´', '682': 'üá®üá∞', '683': 'üá≥üá∫', '685': 'üáºüá∏',
    '686': 'üá∞üáÆ', '687': 'üá≥üá®', '688': 'üáπüáª', '689': 'üáµüá´', '690': 'üáπüá∞', '691': 'üá´üá≤',
    '692': 'üá≤üá≠'
  };

  let texto = `*!  MENCION GENERAL  !*\n`;
  texto += `   *PARA ${total} MIEMBROS* üîî\n\n`;

  for (const user of participants) {
    const numero = user.id.split('@')[0];

    let flag = 'üö©';
    const lada = numero.startsWith('+') ? numero.slice(1) : numero;

    // Buscar coincidencia con prefijo m√°s largo posible
    const ladaMatch = Object.keys(flags)
      .sort((a, b) => b.length - a.length) // ordenar por longitud desc
      .find(code => lada.startsWith(code));

    if (ladaMatch) flag = flags[ladaMatch];

    texto += `‚îä¬ª ${flag} @${numero}\n`;
  }

  await conn.sendMessage(m.chat, { react: { text: 'üîä', key: m.key } });

  await conn.sendMessage(m.chat, {
    text: texto,
    mentions: participants.map(p => p.id)
  }, { quoted: m });
};

handler.customPrefix = /^\.?(todos|invocar|invocacion|invocaci√≥n)$/i;
handler.command = new RegExp();
handler.group = true;
handler.admin = true;

export default handler;